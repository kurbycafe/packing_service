<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Scan & Pack</title>
  <script src="https://code.jquery.com/jquery-latest.min.js"></script>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">

  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">

  <style>
    body {
      background: #f0f2f5;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      padding-top: 50px;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .scan-card {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      padding: 30px;
      width: 100%;
      max-width: 1200px;
    }
    .highlight { animation: blink 0.7s alternate infinite; }
    @keyframes blink { from { background-color: #fff3cd; } to { background-color: #ffeeba; } }
    #summaryInfo { font-size: 16px; font-weight: 500; margin-top: 10px; }
    #log { font-size: 14px; background: #f9f9f9; border: 1px solid #ddd; padding: 10px; height: 120px; overflow-y: auto; border-radius: 5px; }
    #errorItems { margin-top: 20px; }
    input.form-control {
      font-size: 18px;
    }
    .progress { height: 25px; border-radius: 12px; overflow: hidden; }
    .btn { font-weight: 500; }
    .nav-tabs .nav-link { font-weight: 500; }
    table.table td, table.table th { vertical-align: middle; }
    .scan-header {
      text-align: center;
      margin-bottom: 20px;
      font-size: 28px;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <!-- header include -->
<div th:replace="fragments/header :: header"></div>
  <div class="scan-card">
    <div class="scan-header">ğŸ“¦ Scan & Pack</div>

    <!-- ì§„í–‰ë¥  -->
    <div class="progress mb-3">
      <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated"
           role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
    </div>
    <div id="summaryInfo">â± ê²½ê³¼ ì‹œê°„: 0ì´ˆ</div>

    <!-- ì…ë ¥ -->
    <input id="orderBarcode" class="form-control mb-2" placeholder="ì£¼ë¬¸ë²ˆí˜¸ ìŠ¤ìº”">
    <input id="productBarcode" class="form-control mb-2" placeholder="ìƒí’ˆ ë°”ì½”ë“œ ìŠ¤ìº”" disabled>

    <div id="loadingIndicator" style="display:none; color:#007bff; font-weight:bold; margin-bottom:10px;">â³ ì£¼ë¬¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>

    <!-- ë²„íŠ¼ ë° í•„í„° -->
    <div class="mb-3 d-flex flex-wrap align-items-center">
      <button id="completeAllButton" class="btn btn-primary mr-2 mb-2">âœ… ì „ì²´ ìƒí’ˆ ì™„ë£Œã„´</button>
      <button id="saveButton" class="btn btn-success mr-2 mb-2">ğŸ’¾ ì €ì¥</button>
      <button id="resetButton" class="btn btn-secondary mr-2 mb-2">ğŸ”„ ì´ˆê¸°í™”</button>
      
      <div class="btn-group ml-auto mb-2">
        <button class="btn btn-outline-dark filter-btn active" data-filter="all">ì „ì²´</button>
        <button class="btn btn-outline-warning filter-btn" data-filter="progress">ì§„í–‰ì¤‘</button>
        <button class="btn btn-outline-success filter-btn" data-filter="done">ì™„ë£Œ</button>
      </div>
    </div>

    <div id="orderItems" class="mt-3"></div>

    <!-- ë¡œê·¸ -->
    <h5 class="mt-4">ğŸ“œ ìŠ¤ìº” ë¡œê·¸</h5>
    <div id="log"></div>

    <!-- ì˜¤ë¥˜ ìƒí’ˆ ëª©ë¡ -->
    <div id="errorItems"></div>
  </div>

  <!-- ì²˜ë¦¬ ëª¨ë‹¬ -->
  <div class="modal fade" id="processModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">ìƒí’ˆ ì²˜ë¦¬</h5>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>
        <div class="modal-body" id="processModalBody"></div>
      </div>
    </div>
  </div>

  <!-- JS -->
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
  <script>
  $(function () {
    let orderItems = [];
    let scannedErrorItems = [];
    let startTime = null;
    let currentFilter = 'all';
    let progressTimer = null;

    // ì£¼ë¬¸ë²ˆí˜¸ ìŠ¤ìº”
    $('#orderBarcode').keydown(function(e){
      if(e.key!=='Enter') return;
      e.preventDefault();
      const orderNumber=$(this).val().trim();
      if(!orderNumber) return;
      $('#loadingIndicator').show();
      $.post('/api/getOrderDetail',{ orderNumber },function(response){
        $('#loadingIndicator').hide();
        try{ response=typeof response==='string'?JSON.parse(response):response; }catch{ alert('ì‘ë‹µ ì˜¤ë¥˜'); return; }
        if(response.length){
          startTime=Date.now();
          orderItems=response.map((item,i)=>({...item,sku:String(item.sku||'').trim(),scannedCount:0,index:i}));
          scannedErrorItems=[];
          renderOrderItems(); updateProgressBar();
          $('#orderBarcode').prop('disabled',true); $('#productBarcode').prop('disabled',false).focus();
          localStorage.setItem('scanProgress',JSON.stringify(orderItems));
          localStorage.setItem('scanStartTime',startTime);
          startTimer();
        }else alert('ì£¼ë¬¸ ì—†ìŒ');
      });
    });

    // ìƒí’ˆ ë°”ì½”ë“œ ìŠ¤ìº”
    $('#productBarcode').keydown(function(e){
      if(e.key!=='Enter') return;
      e.preventDefault();
      let code=$(this).val().trim();
      $(this).val('');
      if(!code) return;
      code=code.replace(/^0+/,'');
      const found=orderItems.find(i=>i.sku.replace(/^0+/,'')===code || i.name.toLowerCase().includes(code.toLowerCase()));
      if(!found){
        $('#log').prepend(`<div class="text-danger">âŒ [${new Date().toLocaleTimeString()}] ë“±ë¡ë˜ì§€ ì•Šì€ ìƒí’ˆ: ${code}</div>`);
        scannedErrorItems.push({ name:'ë¯¸ë“±ë¡', sku:code });
        renderErrorItems();
        return;
      }
      if(found.scannedCount>=found.quantity){
        $('#log').prepend(`<div class="text-warning">âš ï¸ [${new Date().toLocaleTimeString()}] ${found.name} ì´ë¯¸ ì™„ë£Œë¨</div>`);
        return;
      }
      found.scannedCount++;
      $('#log').prepend(`<div class="text-success">âœ… [${new Date().toLocaleTimeString()}] ${found.name} (${found.scannedCount}/${found.quantity})</div>`);
      renderOrderItems(); highlightRow(found.sku); updateProgressBar();
      localStorage.setItem('scanProgress',JSON.stringify(orderItems));
    });

    // í…Œì´ë¸” ë Œë”ë§
    function renderOrderItems(){
      if(!orderItems.length) return $('#orderItems').html('');
      let html=`<table class="table table-bordered table-sm"><thead><tr>
<th>ìƒí’ˆ ì´ë¯¸ì§€</th><th>ìƒí’ˆëª…</th><th>ìœ í†µê¸°í•œ</th><th>SKU</th>
<th>ê°œë³„ ê°€ê²©</th><th>ì£¼ë¬¸ìˆ˜ëŸ‰</th><th>ìŠ¤ìº”ìˆ˜ëŸ‰</th><th>ìƒíƒœ</th>
<th>+1</th><th>-1</th><th>ì™„ë£Œ</th><th>ì²˜ë¦¬</th><th>ì˜¤ë¥˜ì¶”ê°€</th>
</tr></thead><tbody>`;
      orderItems.forEach((i,idx)=>{
        const done=i.scannedCount>=i.quantity;
        if(currentFilter==='done'&&!done) return;
        if(currentFilter==='progress'&&done) return;
        const rowId=CSS.escape(i.sku||'nosku'+idx);
        const imageUrl=i.imageUrl||'';
        const unitPrice=i.price??0.0;
        html+=`<tr class="${done?'table-success':'table-warning'}" id="${rowId}">
<td>${imageUrl?`<img src="${imageUrl}" style="width:50px;height:auto;">`:''}</td>
<td>${i.name}</td>
<td>${i.MHD??''}</td>
<td>${i.sku??''}</td>
<td>${unitPrice.toFixed(2)}</td>
<td>${i.quantity}</td>
<td>${i.scannedCount}</td>
<td>${done?'ì™„ë£Œ':'ì§„í–‰ì¤‘'}</td>
<td><button class="btn btn-sm btn-outline-primary inc" data-idx="${idx}">+1</button></td>
<td><button class="btn btn-sm btn-outline-danger dec" data-idx="${idx}">-1</button></td>
<td><button class="btn btn-sm btn-success scanAll" data-idx="${idx}">ì™„ë£Œ</button></td>
<td><button class="btn btn-sm btn-secondary process" data-idx="${idx}">ì²˜ë¦¬</button></td>
<td><button class="btn btn-sm btn-danger addError" data-idx="${idx}">âŒ ì˜¤ë¥˜</button></td>
</tr>`;
      });
      html+='</tbody></table>';
      $('#orderItems').html(html);
    }

    // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
    function updateProgressBar(){
      const total=orderItems.reduce((a,i)=>a+i.quantity,0);
      const done=orderItems.reduce((a,i)=>a+i.scannedCount,0);
      const progress=total?Math.round(done/total*100):0;
      $('#progressBar').css('width',progress+'%').text(progress+'%');
      if(progress<50) $('#progressBar').removeClass('bg-success bg-warning').addClass('bg-info');
      else if(progress<100) $('#progressBar').removeClass('bg-success bg-info').addClass('bg-warning');
      else { $('#progressBar').removeClass('bg-warning bg-info').addClass('bg-success'); $('#progressBar').removeClass('progress-bar-striped progress-bar-animated').text('âœ… ì™„ë£Œ'); if(confirm('ëª¨ë“  ìƒí’ˆì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) $('#saveButton').click(); }
      if(progress<100) $('#progressBar').addClass('progress-bar-striped progress-bar-animated');
    }

    // ì˜¤ë¥˜ ì¶”ê°€
    $('#orderItems').on('click','.addError',function(){
      const idx=$(this).data('idx');
      const item=orderItems[idx];
      if(!scannedErrorItems.find(e=>e.sku===item.sku)){
        scannedErrorItems.push({ name:item.name,sku:item.sku });
        renderErrorItems();
        $('#log').prepend(`<div class="text-danger">âŒ [${new Date().toLocaleTimeString()}] ${item.name} ì˜¤ë¥˜ë¡œ ì¶”ê°€ë¨</div>`);
      }else{ alert('ì´ë¯¸ ì˜¤ë¥˜ ëª©ë¡ì— ì¶”ê°€ëœ ìƒí’ˆì…ë‹ˆë‹¤.'); }
    });

    // ì‹œê°„ í‘œì‹œ
    function startTimer(){
      if(progressTimer) clearInterval(progressTimer);
      progressTimer=setInterval(()=>{
        if(!startTime) return;
        const elapsed=Math.floor((Date.now()-startTime)/1000);
        const total=orderItems.reduce((a,i)=>a+i.quantity,0);
        const done=orderItems.reduce((a,i)=>a+i.scannedCount,0);
        const progress=total?Math.round(done/total*100):0;
        $('#summaryInfo').text(`â± ê²½ê³¼ ì‹œê°„: ${elapsed}ì´ˆ | ì™„ë£Œ: ${done}/${total} (${progress}%)`);
      },1000);
    }

    // ì˜¤ë¥˜ ëª©ë¡ ë Œë”ë§
    function renderErrorItems(){
      if(!scannedErrorItems.length) return $('#errorItems').html('');
      let html=`<h5 class="text-danger">âŒ ì˜¤ë¥˜ ìƒí’ˆ ëª©ë¡</h5><table class="table table-bordered table-sm"><thead><tr><th>ìƒí’ˆëª…</th><th>SKU</th></tr></thead><tbody>`;
      scannedErrorItems.forEach(i=>{ html+=`<tr><td>${i.name}</td><td>${i.sku}</td></tr>`; });
      html+='</tbody></table>';
      $('#errorItems').html(html);
    }

    // ë²„íŠ¼ ì´ë²¤íŠ¸
    $('#completeAllButton').click(function(){ orderItems.forEach(i=>i.scannedCount=i.quantity); renderOrderItems(); updateProgressBar(); localStorage.setItem('scanProgress',JSON.stringify(orderItems)); });
    $('#resetButton').click(function(){ if(confirm('ì§„í–‰ ì¤‘ì¸ ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')){ orderItems=[]; scannedErrorItems=[]; startTime=null; $('#orderItems').html(''); $('#errorItems').html(''); $('#log').html(''); $('#orderBarcode').prop('disabled',false).val('').focus(); $('#productBarcode').prop('disabled',true).val(''); updateProgressBar(); localStorage.removeItem('scanProgress'); localStorage.removeItem('scanStartTime'); }});
    $('#orderItems').on('click','.inc',function(){ const idx=$(this).data('idx'); if(orderItems[idx].scannedCount<orderItems[idx].quantity) orderItems[idx].scannedCount++; renderOrderItems(); updateProgressBar(); });
    $('#orderItems').on('click','.dec',function(){ const idx=$(this).data('idx'); if(orderItems[idx].scannedCount>0) orderItems[idx].scannedCount--; renderOrderItems(); updateProgressBar(); });
    $('#orderItems').on('click','.scanAll',function(){ const idx=$(this).data('idx'); orderItems[idx].scannedCount=orderItems[idx].quantity; renderOrderItems(); updateProgressBar(); $('#productBarcode').focus(); });

   // ---------------- ìƒí’ˆ ì²˜ë¦¬ ëª¨ë‹¬ ----------------
$('#orderItems').on('click', '.process', function() {
  const i = orderItems[$(this).data('idx')];

let originalHtml = `
  <div class="border rounded p-3 bg-light">
    <h5 class="text-primary mb-3">ğŸ“¦ ì›ë˜ ìƒí’ˆ ì •ë³´</h5>
    <table class="table table-sm table-hover table-bordered mb-3 bg-white shadow-sm">
      <tbody>
        <tr><th style="width:120px;">ìƒí’ˆëª…</th><td>${i.name}</td></tr>
        <tr><th>SKU</th><td>${i.sku}</td></tr>
        <tr><th>ìœ í†µê¸°í•œ</th><td>${i.MHD || '-'}</td></tr>
        <tr><th>ê°€ê²©</th><td>${i.price ? i.price.toFixed(2) + ' â‚¬' : '-'}</td></tr>
        <tr><th>ì£¼ë¬¸ìˆ˜ëŸ‰</th><td>${i.quantity}</td></tr>
        <tr><th>ìŠ¤ìº”ìˆ˜ëŸ‰</th><td>${i.scannedCount}</td></tr>
      </tbody>
    </table>
  </div>`;

let tabsHtml = `
  <ul class="nav nav-tabs mt-3" id="processTab" role="tablist">
    <li class="nav-item">
      <a class="nav-link active text-danger font-weight-bold" id="refund-tab" data-toggle="tab" href="#refund" role="tab">ğŸ’¸ í™˜ë¶ˆ</a>
    </li>
    <li class="nav-item">
      <a class="nav-link text-warning font-weight-bold" id="replace-tab" data-toggle="tab" href="#replace" role="tab">ğŸ” ëŒ€ì²´</a>
    </li>
    <li class="nav-item">
      <a class="nav-link text-info font-weight-bold" id="point-tab" data-toggle="tab" href="#point" role="tab">ğŸ’ ì ë¦½</a>
    </li>
  </ul>

  <div class="tab-content border-left border-right border-bottom rounded-bottom p-3 bg-white shadow-sm">
    <!-- í™˜ë¶ˆ -->
    <div class="tab-pane fade show active" id="refund" role="tabpanel">
      <h6 class="text-danger font-weight-bold">ğŸ’¸ í™˜ë¶ˆ ì •ë³´ ì…ë ¥</h6>
      <input class="form-control mb-2" placeholder="í™˜ë¶ˆ ìƒí’ˆëª…" id="refundName">
      <input class="form-control mb-2" placeholder="ìœ í†µê¸°í•œ (YYYY-MM-DD)" id="refundMHD">
      <input type="number" class="form-control mb-3" placeholder="í™˜ë¶ˆ ìˆ˜ëŸ‰" id="refundQty" min="1">
      <button class="btn btn-danger btn-block font-weight-bold" id="refundBtn">âœ… í™˜ë¶ˆ ì™„ë£Œ</button>
    </div>

    <!-- ëŒ€ì²´ -->
    <div class="tab-pane fade" id="replace" role="tabpanel">
      <h6 class="text-warning font-weight-bold">ğŸ” ëŒ€ì²´ ìƒí’ˆ ì…ë ¥</h6>
      <input class="form-control mb-2" placeholder="ëŒ€ì²´ ìƒí’ˆëª…" id="replaceName">
      <input class="form-control mb-2" placeholder="ìœ í†µê¸°í•œ (YYYY-MM-DD)" id="replaceMHD">
      <input type="number" class="form-control mb-3" placeholder="ëŒ€ì²´ ìˆ˜ëŸ‰" id="replaceQty" min="1">
      <button class="btn btn-warning btn-block font-weight-bold" id="replaceBtn">âœ… ëŒ€ì²´ ì™„ë£Œ</button>
    </div>

    <!-- ì ë¦½ -->
    <div class="tab-pane fade" id="point" role="tabpanel">
      <h6 class="text-info font-weight-bold">ğŸ’ ì ë¦½ ì²˜ë¦¬</h6>
      <input type="number" class="form-control mb-3" placeholder="ì ë¦½ ìˆ˜ëŸ‰" id="pointQty" min="1">
      <button class="btn btn-info btn-block font-weight-bold" id="pointBtn">âœ… ì ë¦½ ì™„ë£Œ</button>
    </div>
  </div>
`;


  $('#processModalBody').html(originalHtml + tabsHtml);
  $('#processModal').modal('show');

  // âœ… í™˜ë¶ˆ ë²„íŠ¼
  $('#refundBtn').off('click').on('click', function() {
    const qty = parseInt($('#refundQty').val());
    if (!qty || qty < 1) return alert('ìˆ˜ëŸ‰ ì…ë ¥ í•„ìš”');
    const entry = {
      type: 'í™˜ë¶ˆ',
      productName: $('#refundName').val(),
      MHD: $('#refundMHD').val(),
      quantity: qty
    };
    i.processHistory = i.processHistory || [];
    i.processHistory.push(entry);

    $('#log').prepend(`<div class="text-danger">ğŸ’¸ [${new Date().toLocaleTimeString()}] ${i.name} ${qty}ê°œ í™˜ë¶ˆ ì²˜ë¦¬ë¨</div>`);
    $('#processModal').modal('hide');
    renderOrderItems();
  });

  // âœ… ëŒ€ì²´ ë²„íŠ¼
  $('#replaceBtn').off('click').on('click', function() {
    const qty = parseInt($('#replaceQty').val());
    if (!qty || qty < 1) return alert('ìˆ˜ëŸ‰ ì…ë ¥ í•„ìš”');
    const entry = {
      type: 'ëŒ€ì²´',
      productName: $('#replaceName').val(),
      MHD: $('#replaceMHD').val(),
      quantity: qty
    };
    i.processHistory = i.processHistory || [];
    i.processHistory.push(entry);

    $('#log').prepend(`<div class="text-warning">ğŸ” [${new Date().toLocaleTimeString()}] ${i.name} ${qty}ê°œ ëŒ€ì²´ ì²˜ë¦¬ë¨</div>`);
    $('#processModal').modal('hide');
    renderOrderItems();
  });

  // âœ… ì ë¦½ ë²„íŠ¼
  $('#pointBtn').off('click').on('click', function() {
    const qty = parseInt($('#pointQty').val());
    if (!qty || qty < 1) return alert('ìˆ˜ëŸ‰ ì…ë ¥ í•„ìš”');
    const entry = { type: 'ì ë¦½', quantity: qty };
    i.processHistory = i.processHistory || [];
    i.processHistory.push(entry);

    $('#log').prepend(`<div class="text-info">ğŸ’ [${new Date().toLocaleTimeString()}] ${i.name} ${qty}ê°œ ì ë¦½ ì²˜ë¦¬ë¨</div>`);
    $('#processModal').modal('hide');
    renderOrderItems();
  });
});
// ì €ì¥ ë²„íŠ¼ í´ë¦­ ì‹œ
    // -------------------
    $('#saveButton').click(function () {
      //orderNumber
        const orderNumber = $('#orderBarcode').val().trim();
        //check if tscanning is complete
        const isScanningComplete = orderItems.every(item => item.scannedCount === item.quantity);
if (!isScanningComplete) {
    const proceed = confirm('ëª¨ë“  ìƒí’ˆì´ ìŠ¤ìº”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
    if (!proceed) {
        return false; // ì‚¬ìš©ìê°€ "ì·¨ì†Œ"ë¥¼ ëˆ„ë¥´ë©´ ì§„í–‰ ì¤‘ë‹¨
    }
}


        const scannedItems = orderItems.map(item => ({
            orderNumber,
            mhd: item.MHD, 
            productName: item.name,
            productQ: item.quantity,
            productSku: item.sku,
            scannedCount: item.scannedCount
        }));
        console.log(scannedItems);

        const errorItemsPayload = scannedErrorItems.map(item => ({
            orderNumber,
            productName: item.name,
            productSku: item.sku
        }));

        const payload = { scannedItems, scannedErrorItems: errorItemsPayload };

        $.ajax({
            url: '/api/saveScannedItems',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(payload),
            success: function () {
                alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                $('#orderBarcode').prop('disabled', false).val('').focus();
                $('#productBarcode').prop('disabled', true).val('');
                $('#orderItems').html('');
                orderItems = [];
                scannedErrorItems = [];
                updateProgressBar(); // âœ… ì´ˆê¸°í™”
                $('#resetButton').click();

            },
            error: function (xhr) {
                alert('ì €ì¥ ì˜¤ë¥˜: ' + xhr.responseText);
            }
        });
    });
    // í•„í„°
    $('.filter-btn').click(function(){
      $('.filter-btn').removeClass('active');
      $(this).addClass('active');
      currentFilter=$(this).data('filter');
      renderOrderItems();
    });

    // ë¡œì»¬ ì €ì¥ ë³µì›
    const savedProgress=localStorage.getItem('scanProgress');
    if(savedProgress) orderItems=JSON.parse(savedProgress);
    const savedTime=localStorage.getItem('scanStartTime');
    if(savedTime) startTime=parseInt(savedTime);
    if(orderItems.length){ renderOrderItems(); startTimer(); $('#orderBarcode').prop('disabled',true); $('#productBarcode').prop('disabled',false); }

    // í–‰ í•˜ì´ë¼ì´íŠ¸
    function highlightRow(sku){
      const rowId=CSS.escape(sku);
      const row=$(`#${rowId}`);
      row.addClass('highlight');
      setTimeout(()=>row.removeClass('highlight'),700);
    }
  });
  </script>
</body>
</html>
<!DOCTYPE html>