<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="de">
<head>
    <meta charset="UTF-8">
    <title>Scan & Pack</title>
    <script src="https://code.jquery.com/jquery-latest.min.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body>
<div th:replace="fragments/header :: header "></div>

<div class="container mt-5">

    <div class="progress mb-4" style="height: 25px;">
        <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" 
             style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
    </div>

    <input id="orderBarcode" placeholder="order number scan" style="width: 300px; font-size: 20px;"/>
    <input id="productBarcode" placeholder="product barcode scan" style="width: 300px; font-size: 20px;" disabled />

    <div id="loadingIndicator" style="display: none; font-weight: bold; color: #007bff; margin-top: 20px;">
        ⏳ 주문 정보를 불러오는 중입니다...
    </div>

    <div id="orderItems" style="margin-top:30px;"></div>
    <button id="saveButton" class="btn btn-success mt-3">Save</button>
</div>

<script>
$(function () {
    let orderItems = [];
    let scannedErrorItems = [];

    // -------------------
    // 주문 번호 스캔
    // -------------------
    $('#orderBarcode').on('keydown', function (e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            const orderNumber = $(this).val().trim();
            if (!orderNumber) return;

            $('#loadingIndicator').show();

            $.post('/api/getOrderDetail', { orderNumber }, function (response) {
                $('#loadingIndicator').hide();

                if (typeof response === 'string') {
                    try {
                        response = JSON.parse(response);
                    } catch (e) {
                        $('#orderItems').html(`<p style="color:red;">응답 오류: ${response}</p>`);
                        return;
                    }
                }

                if (response.length > 0) {
                    $('#orderBarcode').prop('disabled', true);
                    $('#productBarcode').prop('disabled', false).focus();
                    orderItems = response.map((item, index) => ({ ...item, scannedCount: 0, index }));
                    renderOrderItems();
                    updateProgressBar();
                } else {
                    $('#orderItems').html(`<p style="color:red;">주문을 찾을 수 없습니다.</p>`);
                }
            }).fail(xhr => {
                $('#loadingIndicator').hide();
                $('#orderItems').html(`<p style="color:red;">오류 발생: ${xhr.responseText}</p>`);
            });
        }
    });

    // -------------------
    // 테이블 렌더링
    // -------------------
    function renderOrderItems() {
        if (!orderItems.length) return $('#orderItems').html('');
        const orderNumber = orderItems[0].orderNumber;

        let html = `<h3>Order #${orderNumber}</h3><table class="table table-bordered"><thead><tr>
            <th>상품명</th><th>유통기한</th><th>SKU</th><th>주문 수량</th><th>스캔된 수량</th><th>상태</th><th>조정</th>   <th>오류로 +1</th><th>처리</th>
            </tr></thead><tbody>`;

        orderItems.forEach((item, i) => {
            const isDone = item.scannedCount >= item.quantity;
            const statusClass = isDone ? 'table-success' : 'table-warning';
            const rowId = item.sku ? item.sku : `no-sku-${i}`;
            html += `<tr class="${statusClass}" id="${CSS.escape(rowId)}">
                <td>${item.name}</td>
                <td>${item.MHD ?? ''}</td>
                <td>${item.sku ?? 'N/A'}</td>
                <td>${item.quantity}</td>
                <td>${item.scannedCount}</td>
                <td>${isDone ? '완료' : '진행 중'}</td>
                <td><button class="btn btn-sm btn-primary scan-all-btn" data-index="${i}">완료</button></td>
                <td><button class="btn btn-sm btn-primary increase-btn" data-index="${i}">+1 오류로 추가</button></td>
                 <td><button class="btn btn-sm btn-primary process-btn" data-index="${i}">처리</button></td>
            </tr>`;
        });

        html += '</tbody></table>';
        $('#orderItems').html(html);
    }

    // -------------------
    // 상품 바코드 스캔
    // -------------------
    $('#productBarcode').on('keydown', function (e) {
        if (e.key === 'Enter') {
            e.preventDefault();

            const barcode = $(this).val().trim();
            $(this).val('');
            if (!barcode) return alert("바코드를 입력해주세요.");

            const foundItem = orderItems.find(item => item.sku && item.sku === barcode);
            if (!foundItem) return alert('주문 내역에 없는 상품이거나 SKU 정보가 없습니다.');

            if (foundItem.scannedCount < foundItem.quantity) {
                foundItem.scannedCount++;
                renderOrderItems();
                highlightRow(barcode);

                updateProgressBar(); // ✅ scannedCount 증가 후 호출
            } else {
                alert(`상품 "${foundItem.name}"는 이미 모두 스캔되었습니다.`);
            }
        }
    });

    // -------------------
    // 오류로 +1 수동 추가
    // -------------------
    $('#orderItems').on('click', '.increase-btn', function () {
        const index = $(this).data('index');
        const item = orderItems[index];
        if (!item) return alert('상품 정보를 찾을 수 없습니다.');

        if (item.scannedCount < item.quantity) {
            if (!scannedErrorItems.some(i => i.sku === item.sku)) {
                scannedErrorItems.push({ sku: item.sku, name: item.name });
            }
            item.scannedCount++;
            renderOrderItems();
            updateProgressBar(); // ✅ 진행률 업데이트
        } else {
            alert(`상품 "${item.name}"는 이미 모두 스캔되었습니다.`);
        }
    });

    // -------------------
    // 해당 상품 처리
    // -------------------

    // $('#orderItems').on('click', '.process-btn', function () {
    //     const index = $(this).data('index');
    //     const item = orderItems[index];
    //     if (!item) return alert('상품 정보를 찾을 수 없습니다.');

    //     const popupHtml = `
    //         <div>
    //             <h3>상품 처리</h3>
    //             <p>상품명: ${item.name}</p>
    //             <p>주문 수량: ${item.quantity}</p>
    //             <p>스캔된 수량: ${item.scannedCount}</p>

    //             <input type="number" id="refundQuantity" placeholder="환불 수량" min="1" max="${item.scannedCount}">
    //              <button id="refundBtn">환불 처리</button>
    //             <input type="number" id="replaceQuantity" placeholder="대체 수량" min="1" max="${item.scannedCount}">
               
    //             <button id="replaceBtn">대체 처리</button>
    //         </div>
    //     `;
    //     showModal('상품 처리', popupHtml);
    // });
    // showModal = function(title, content) {
    //     const modalHtml = `
    //         <div class="modal" tabindex="-1" role="dialog" style="display:block; background: rgba(0,0,0,0.5);">
    //           <div class="modal-dialog" role="document">
    //             <div class="modal-content">
    //               <div class="modal-header">
    //                 <h5 class="modal-title">${title}</h5>
    //                 <button type="button" class="close" data-dismiss="modal" aria-label="Close" id="closeModalBtn">
    //                   <span aria-hidden="true">&times;</span>
    //                 </button>
    //               </div>
    //               <div class="modal-body">
    //                 ${content}
    //                 </div>
    //             </div>
    //         </div>
    //     `;
    //     $('body').append(modalHtml);
    //     $('#closeModalBtn').click(function() {
    //         $('.modal').remove();
    //     });

    // };

    // -------------------
    // 해당 상품 전체 스캔 처리
    // -------------------
    $('#orderItems').on('click', '.scan-all-btn', function () {
        const index = $(this).data('index');
        const item = orderItems[index];

        if (!item) return alert('상품 정보를 찾을 수 없습니다.');

        if (item.scannedCount < item.quantity) {
            item.scannedCount = item.quantity;
            renderOrderItems();
            updateProgressBar(); // ✅ 진행률 업데이트
        } else {
            alert(`상품 "${item.name}"는 이미 모두 스캔되었습니다.`);
        }
    });

    // -------------------
    // 저장 버튼 클릭 시
    // -------------------
    $('#saveButton').click(function () {
        //check if tscanning is complete
        const isScanningComplete = orderItems.every(item => item.scannedCount === item.quantity);
        if (!isScanningComplete) {
            alert('모든 상품이 스캔되지 않았습니다.');
            return false;
        }

        const scannedItems = orderItems.map(item => ({
            orderNumber,
            mhd: item.MHD, 
            productName: item.name,
            productQ: item.quantity,
            productSku: item.sku,
            scannedCount: item.scannedCount
        }));
        console.log(scannedItems);

        const errorItemsPayload = scannedErrorItems.map(item => ({
            orderNumber,
            productName: item.name,
            productSku: item.sku
        }));

        const payload = { scannedItems, scannedErrorItems: errorItemsPayload };

        $.ajax({
            url: '/api/saveScannedItems',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(payload),
            success: function () {
                alert('저장되었습니다.');
                $('#orderBarcode').prop('disabled', false).val('').focus();
                $('#productBarcode').prop('disabled', true).val('');
                $('#orderItems').html('');
                orderItems = [];
                scannedErrorItems = [];
                updateProgressBar(); // ✅ 초기화
            },
            error: function (xhr) {
                alert('저장 오류: ' + xhr.responseText);
            }
        });
    });

    // -------------------
    // 행 하이라이트 효과
    // -------------------
    function highlightRow(barcode) {
        if (!barcode) return;
        const $row = $("#" + CSS.escape(barcode));
        if ($row.length === 0) return;

        $row.addClass("table-warning").fadeTo(100, 0.1).fadeTo(200, 1.0, function () {
            setTimeout(() => $row.removeClass("table-warning"), 1000);
        });
    }

    // -------------------
    // 진행률 표시 업데이트
    // -------------------
    function updateProgressBar() {
        const itemsArray = Object.values(orderItems);

        const totalItems = itemsArray.reduce((sum, item) => sum + (item.quantity || 0), 0);
        const totalScanned = itemsArray.reduce((sum, item) => sum + (item.scannedCount || 0), 0);

        const progress = totalItems === 0 ? 0 : Math.round((totalScanned / totalItems) * 100);

        const $bar = $('#progressBar');
        $bar.css('width', `${progress}%`).attr('aria-valuenow', progress).text(`${progress}%`);

        if (progress >= 100) {
            $bar.removeClass('progress-bar-striped progress-bar-animated').addClass('bg-success').text('✅ 완료');
        } else {
            $bar.addClass('progress-bar-striped progress-bar-animated').removeClass('bg-success');
        }
        //if progrss is completed then click save button automatically
        if (progress === 100) {
            $('#saveButton').click();
        }
        
    }
});
</script>
</body>
</html>
