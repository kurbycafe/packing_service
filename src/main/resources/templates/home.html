<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Scan & Pack</title>
  <script src="https://code.jquery.com/jquery-latest.min.js"></script>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <style>
    body { background: #f8f9fa; }
    .highlight { animation: blink 0.7s alternate infinite; }
    @keyframes blink { from { background-color: #fff3cd; } to { background-color: #ffeeba; } }
    #summaryInfo { font-size: 18px; font-weight: bold; }
  </style>
</head>
<body>
<div class="container mt-5">
  <h2>ğŸ“¦ Scan & Pack</h2>

  <!-- ì§„í–‰ë¥  -->
  <div class="progress mb-4" style="height: 25px;">
    <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated"
         role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
  </div>

  <!-- ì…ë ¥ -->
  <input id="orderBarcode" class="form-control mb-2" placeholder="ì£¼ë¬¸ë²ˆí˜¸ ìŠ¤ìº”" style="font-size:20px;">
  <input id="productBarcode" class="form-control mb-2" placeholder="ìƒí’ˆ ë°”ì½”ë“œ ìŠ¤ìº”" style="font-size:20px;" disabled>

  <div id="loadingIndicator" style="display:none; color:#007bff; font-weight:bold;">â³ ì£¼ë¬¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>

  <!-- ì „ì²´ ìƒí’ˆ ì™„ë£Œ ë²„íŠ¼ -->
  <button id="completeAllButton" class="btn btn-primary mb-3">âœ… ì „ì²´ ìƒí’ˆ ì™„ë£Œ</button>

  <div id="orderItems" class="mt-4"></div>
  <button id="saveButton" class="btn btn-success mt-3">ğŸ’¾ ì €ì¥</button>
</div>

<!-- ì²˜ë¦¬ ëª¨ë‹¬ -->
<div class="modal fade" id="processModal" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">ìƒí’ˆ ì²˜ë¦¬</h5>
        <button type="button" class="close" data-dismiss="modal">&times;</button>
      </div>
      <div class="modal-body" id="processModalBody"></div>
    </div>
  </div>
</div>

<script>
$(function () {
  let orderItems = [];
  let scannedErrorItems = [];
  let startTime = null;
  const soundSuccess = new Audio('/sounds/success.mp3');
  const soundError = new Audio('/sounds/error.mp3');
  const tts = window.speechSynthesis;

  // ---------------- ì£¼ë¬¸ë²ˆí˜¸ ìŠ¤ìº” ----------------
  $('#orderBarcode').keydown(function(e){
    if(e.key !== 'Enter') return;
    e.preventDefault();
    const orderNumber = $(this).val().trim();
    if(!orderNumber) return;

    $('#loadingIndicator').show();
    $.post('/api/getOrderDetail', { orderNumber }, function(response){
      $('#loadingIndicator').hide();
      try { response = typeof response === 'string' ? JSON.parse(response) : response; } catch { alert('ì‘ë‹µ ì˜¤ë¥˜'); return; }

      if(response.length){
        startTime = Date.now();
        orderItems = response.map((item,i)=>({
          ...item,
          sku: String(item.sku||'').trim(),
          scannedCount: 0,
          index: i
        }));
        scannedErrorItems = [];
        renderOrderItems();
        updateProgressBar();
        $('#orderBarcode').prop('disabled',true);
        $('#productBarcode').prop('disabled',false).focus();
        localStorage.setItem('scanProgress', JSON.stringify(orderItems));
      } else alert('ì£¼ë¬¸ ì—†ìŒ');
    });
  });

  // ---------------- ìƒí’ˆ ë°”ì½”ë“œ ìŠ¤ìº” ----------------
  $('#productBarcode').keydown(function(e){
    if(e.key !== 'Enter') return;
    e.preventDefault();
    let code = $(this).val().trim();
    $(this).val('');
    if(!code) return;

    code = code.replace(/^0+/, '');
    const found = orderItems.find(i=>i.sku.replace(/^0+/,'')===code || i.name.toLowerCase().includes(code.toLowerCase()));
    if(!found){
      playSound(false);
      alert('ì£¼ë¬¸ ë‚´ì—­ì— ì—†ëŠ” ìƒí’ˆ');
      return;
    }

    if(found.scannedCount >= found.quantity){
      playSound(false);
      return alert(`"${found.name}" ì™„ë£Œë¨`);
    }

    found.scannedCount++;
    playSound(true);
    speak(`${found.name} ì™„ë£Œ`);
    renderOrderItems();
    highlightRow(found.sku);
    updateProgressBar();
    localStorage.setItem('scanProgress', JSON.stringify(orderItems));
  });

  // ---------------- í…Œì´ë¸” ë Œë”ë§ ----------------
  function renderOrderItems(){
    if(!orderItems.length) return $('#orderItems').html('');
    let html = `<table class="table table-bordered"><thead><tr>
      <th>ìƒí’ˆ ì´ë¯¸ì§€</th><th>ìƒí’ˆëª…</th><th>ìœ í†µê¸°í•œ</th><th>SKU</th>
      <th>ê°œë³„ ê°€ê²©</th><th>ì£¼ë¬¸ìˆ˜ëŸ‰</th><th>ìŠ¤ìº”ìˆ˜ëŸ‰</th><th>ìƒíƒœ</th>
      <th>+1</th><th>-1</th><th>ì™„ë£Œ</th><th>ì²˜ë¦¬</th>
    </tr></thead><tbody>`;

    orderItems.forEach((i,idx)=>{
      const done = i.scannedCount>=i.quantity;
      const rowId = CSS.escape(i.sku||'nosku'+idx);
      const imageUrl = i.imageUrl||'';
      const unitPrice = i.price??0.0;
      html+=`<tr class="${done?'table-success':'table-warning'}" id="${rowId}">
        <td>${imageUrl?`<img src="${imageUrl}" style="width:50px;height:auto;">`:''}</td>
        <td>${i.name}</td>
        <td>${i.MHD??''}</td>
        <td>${i.sku??''}</td>
        <td>${unitPrice.toFixed(2)}</td>
        <td>${i.quantity}</td>
        <td>${i.scannedCount}</td>
        <td>${done?'ì™„ë£Œ':'ì§„í–‰ì¤‘'}</td>
        <td><button class="btn btn-sm btn-outline-primary inc" data-idx="${idx}">+1</button></td>
        <td><button class="btn btn-sm btn-outline-danger dec" data-idx="${idx}">-1</button></td>
        <td><button class="btn btn-sm btn-success scanAll" data-idx="${idx}">ì™„ë£Œ</button></td>
        <td><button class="btn btn-sm btn-secondary process" data-idx="${idx}">ì²˜ë¦¬</button></td>
      </tr>`;
    });
    html+='</tbody></table>';
    $('#orderItems').html(html);
  }

  // ---------------- ì§„í–‰ë¥  ----------------
  function updateProgressBar(){
    const total = orderItems.reduce((a,i)=>a+i.quantity,0);
    const done = orderItems.reduce((a,i)=>a+i.scannedCount,0);
    const progress = total?Math.round(done/total*100):0;
    $('#progressBar').css('width',progress+'%').text(progress+'%');
    if(progress>=100){
      $('#progressBar').removeClass('progress-bar-striped progress-bar-animated').addClass('bg-success').text('âœ… ì™„ë£Œ');
      saveScan(true);
    } else {
      $('#progressBar').addClass('progress-bar-striped progress-bar-animated').removeClass('bg-success');
    }
  }

  // ---------------- ì „ì²´ ìƒí’ˆ ì™„ë£Œ ----------------
  $('#completeAllButton').click(function(){
    if(!orderItems.length) return alert('ì£¼ë¬¸ì„ ë¨¼ì € ìŠ¤ìº”í•˜ì„¸ìš”');
    orderItems.forEach(i=>i.scannedCount=i.quantity);
    renderOrderItems();
    updateProgressBar();
    playSound(true);
    speak('ëª¨ë“  ìƒí’ˆ ì™„ë£Œ');
    localStorage.setItem('scanProgress', JSON.stringify(orderItems));
  });

  // ---------------- +1/-1/ì „ì²´/ì²˜ë¦¬ ë²„íŠ¼ ----------------
  $('#orderItems').on('click','.inc',function(){
    const idx = $(this).data('idx');
    if(orderItems[idx].scannedCount<orderItems[idx].quantity) orderItems[idx].scannedCount++;
    renderOrderItems(); updateProgressBar();
  });
  $('#orderItems').on('click','.dec',function(){
    const idx = $(this).data('idx');
    if(orderItems[idx].scannedCount>0) orderItems[idx].scannedCount--;
    renderOrderItems(); updateProgressBar();
  });
  $('#orderItems').on('click','.scanAll',function(){
    const idx = $(this).data('idx');
    orderItems[idx].scannedCount = orderItems[idx].quantity;
    renderOrderItems(); updateProgressBar();
  });
  $('#orderItems').on('click','.process',function(){
    const idx = $(this).data('idx');
    $('#processModalBody').html(`<p>ìƒí’ˆ ì²˜ë¦¬: ${orderItems[idx].name}</p>`);
    $('#processModal').modal('show');
  });

  $('#saveButton').click(function () {
    // ì£¼ë¬¸ë²ˆí˜¸
    const orderNumber = orderItems.length > 0 ? orderItems[0].orderNumber : null;

    // ìŠ¤ìº” ì™„ë£Œ ì—¬ë¶€ í™•ì¸
    const isScanningComplete = orderItems.every(item => item.scannedCount === item.quantity);

    // ì™„ë£Œë˜ì§€ ì•Šì•˜ìœ¼ë©´ ì‚¬ìš©ìì—ê²Œ í™•ì¸
    if (!isScanningComplete) {
        if (!confirm('ìŠ¤ìº”ì´ ì™„ë£Œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ê·¸ë˜ë„ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            return;
        }
    }

    // ì •ìƒ ìŠ¤ìº” ì•„ì´í…œ ë³€í™˜
    const scannedItems = orderItems.map(item => ({
        orderNumber,
        mhd: item.MHD,
        productName: item.name,
        productQ: item.quantity,
        productSku: item.sku,
        scannedCount: item.scannedCount
    }));
    console.log(scannedItems);

    // ì˜¤ë¥˜ ì•„ì´í…œ ë³€í™˜
    const errorItemsPayload = scannedErrorItems.map(item => ({
        orderNumber,
        productName: item.name,
        productSku: item.sku
    }));

    // ìš”ì²­ í˜ì´ë¡œë“œ
    const payload = {
        scannedItems,
        scannedErrorItems: errorItemsPayload
    };

    // AJAX í˜¸ì¶œ
    $.ajax({
        url: '/api/saveScannedItems',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(payload),
        success: function () {
            alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');

            // ì´ˆê¸°í™”
            $('#orderBarcode').prop('disabled', false).val('').focus();
            $('#productBarcode').prop('disabled', true).val('');
            $('#orderItems').html('');
            orderItems = [];
            scannedErrorItems = [];
            updateProgressBar(); // âœ… ì§„í–‰ë¥  ì´ˆê¸°í™”
        },
        error: function (xhr) {
            alert('ì €ì¥ ì˜¤ë¥˜: ' + xhr.responseText);
        }
    });
});



  // ---------------- í•˜ì´ë¼ì´íŠ¸ ----------------
  function highlightRow(sku){
    const row=document.getElementById(CSS.escape(sku));
    if(row){ $(row).addClass('highlight'); setTimeout(()=>$(row).removeClass('highlight'),1500); }
  }

  // ---------------- ì‚¬ìš´ë“œ/TTS ----------------
  function playSound(ok){ ok?soundSuccess.play():soundError.play(); }
  function speak(txt){ const u=new SpeechSynthesisUtterance(txt); u.lang='ko-KR'; tts.speak(u); }

});
</script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
</body>
</html>
