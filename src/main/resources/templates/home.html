<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Scan & Pack</title>
  <script src="https://code.jquery.com/jquery-latest.min.js"></script>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <style>
    body { background: #f8f9fa; }
    .highlight { animation: blink 0.7s alternate infinite; }
    @keyframes blink { from { background-color: #fff3cd; } to { background-color: #ffeeba; } }
    #summaryInfo { font-size: 18px; font-weight: bold; }
  </style>
</head>
<body>
<div class="container mt-5">
  <h2>ğŸ“¦ Scan & Pack</h2>

  <!-- ì§„í–‰ë¥  -->
  <div class="progress mb-4" style="height: 25px;">
    <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated"
         role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
  </div>

  <!-- ì…ë ¥ -->
  <input id="orderBarcode" class="form-control mb-2" placeholder="ì£¼ë¬¸ë²ˆí˜¸ ìŠ¤ìº”" style="font-size:20px;">
  <input id="productBarcode" class="form-control mb-2" placeholder="ìƒí’ˆ ë°”ì½”ë“œ ìŠ¤ìº”" style="font-size:20px;" disabled>

  <div id="loadingIndicator" style="display:none; color:#007bff; font-weight:bold;">â³ ì£¼ë¬¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>

  <!-- ì „ì²´ ìƒí’ˆ ì™„ë£Œ ë²„íŠ¼ -->
  <button id="completeAllButton" class="btn btn-primary mb-3">âœ… ì „ì²´ ìƒí’ˆ ì™„ë£Œ</button>

  <div id="orderItems" class="mt-4"></div>
  <button id="saveButton" class="btn btn-success mt-3">ğŸ’¾ ì €ì¥</button>
</div>


<!-- ì²˜ë¦¬ ëª¨ë‹¬ -->
<div class="modal fade" id="processModal" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">ìƒí’ˆ ì²˜ë¦¬</h5>
        <button type="button" class="close" data-dismiss="modal">&times;</button>
      </div>
      <div class="modal-body" id="processModalBody"></div>
    </div>
  </div>
</div>

<script>
$(function () {
  let orderItems = [];
  let startTime = null;
  const soundSuccess = new Audio('/sounds/success.mp3');
  const soundError = new Audio('/sounds/error.mp3');
  const tts = window.speechSynthesis;
$('#completeAllButton').click(function() {
  if (!orderItems.length) return alert('ì£¼ë¬¸ì„ ë¨¼ì € ìŠ¤ìº”í•˜ì„¸ìš”');
  orderItems.forEach(i => i.scannedCount = i.quantity);
  renderOrderItems();
  updateProgressBar();
  playSound(true);
  speak('ëª¨ë“  ìƒí’ˆ ì™„ë£Œ');
});
  // ---------------- ì£¼ë¬¸ ìŠ¤ìº” ----------------
  $('#orderBarcode').keydown(function(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      const orderNumber = $(this).val().trim();
      if (!orderNumber) return;
      $('#loadingIndicator').show();

      $.post('/api/getOrderDetail', { orderNumber }, function(response) {
        $('#loadingIndicator').hide();
        try { response = typeof response === 'string' ? JSON.parse(response) : response; } catch { alert('ì‘ë‹µ ì˜¤ë¥˜'); return; }

        if (response.length) {
          startTime = Date.now();
          orderItems = response.map((item, i) => ({ ...item, scannedCount: 0, index: i }));
          renderOrderItems();
          updateProgressBar();
          $('#orderBarcode').prop('disabled', true);
          $('#productBarcode').prop('disabled', false).focus();
          localStorage.setItem('scanProgress', JSON.stringify(orderItems));
        } else alert('ì£¼ë¬¸ ì—†ìŒ');
      });
    }
  });

  // ---------------- ìƒí’ˆ ìŠ¤ìº” ----------------
  $('#productBarcode').keydown(function(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      let code = $(this).val().trim().replace(/^0+/, '');
      $(this).val('');
      if (!code) return;

      const found = orderItems.find(i => i.sku === code || i.name.includes(code));
      console.log (orderItems)
      if (!found) {
        playSound(false);
        return alert('ì£¼ë¬¸ ë‚´ì—­ì— ì—†ëŠ” ìƒí’ˆ');
      }

      if (found.scannedCount >= found.quantity) {
        playSound(false);
        return alert(`"${found.name}" ì™„ë£Œë¨`);
      }

      found.scannedCount++;
      playSound(true);
      speak(`${found.name} ì™„ë£Œ`);
      renderOrderItems();
      highlightRow(found.sku);
      updateProgressBar();
      localStorage.setItem('scanProgress', JSON.stringify(orderItems));
    }
  });

  // ---------------- í…Œì´ë¸” ë Œë”ë§ ----------------
  function renderOrderItems() {
    let html = `<table class="table table-bordered"><thead><tr>
      <th>ìƒí’ˆ ì´ë¯¸ì§€</th><th>ìƒí’ˆëª…</th><th>ìœ í†µê¸°í•œ</th><th>SKU</th>
      <th>ê°œë³„ ê°€ê²©</th><th>ì£¼ë¬¸ìˆ˜ëŸ‰</th><th>ìŠ¤ìº”ìˆ˜ëŸ‰</th><th>ìƒíƒœ</th>
      <th>+1</th><th>-1</th><th>ì™„ë£Œ</th><th>ì²˜ë¦¬</th>
    </tr></thead><tbody>`;
    orderItems.forEach((i, idx) => {
      const done = i.scannedCount >= i.quantity;
      const rowId = CSS.escape(i.sku || 'nosku'+idx);
      const imageUrl = i.imageUrl || '';
      const unitPrice = i.price ?? 0.0;

      html += `<tr class="${done ? 'table-success' : 'table-warning'}" id="${rowId}">
        <td>${imageUrl ? `<img src="${imageUrl}" alt="${i.name}" style="width:50px;height:auto;">` : ''}</td>
        <td>${i.name}</td>
        <td>${i.MHD ?? ''}</td>
        <td>${i.sku ?? ''}</td>
        <td>${unitPrice.toFixed(2)}</td>
        <td>${i.quantity}</td>
        <td>${i.scannedCount}</td>
        <td>${done ? 'ì™„ë£Œ' : 'ì§„í–‰ì¤‘'}</td>
        <td><button class="btn btn-sm btn-outline-primary inc" data-idx="${idx}">+1</button></td>
        <td><button class="btn btn-sm btn-outline-danger dec" data-idx="${idx}">-1</button></td>
        <td><button class="btn btn-sm btn-success scanAll" data-idx="${idx}">ì™„ë£Œ</button></td>
        <td><button class="btn btn-sm btn-secondary process" data-idx="${idx}">ì²˜ë¦¬</button></td>
      </tr>`;
      if (i.processHistory && i.processHistory.length > 0) {
        html += `<tr><td colspan="12">
          <strong>ì²˜ë¦¬ ë‚´ì—­:</strong>
          ${i.processHistory.map(p => `${p.type}(${p.productName || ''} ${p.quantity})`).join(' | ')}
        </td></tr>`;
      }
    });
    html += '</tbody></table>';
    $('#orderItems').html(html);
  }

  // ---------------- ë²„íŠ¼ ë™ì‘ ----------------
  $('#orderItems').on('click', '.inc', function() {
    const i = orderItems[$(this).data('idx')];
    if (i.scannedCount < i.quantity) i.scannedCount++;
    playSound(true); renderOrderItems(); updateProgressBar();
  });
  $('#orderItems').on('click', '.dec', function() {
    const i = orderItems[$(this).data('idx')];
    if (i.scannedCount > 0) i.scannedCount--;
    playSound(false); renderOrderItems(); updateProgressBar();
  });
  $('#orderItems').on('click', '.scanAll', function() {
    const i = orderItems[$(this).data('idx')];
    i.scannedCount = i.quantity;
    playSound(true); renderOrderItems(); updateProgressBar();
  });

  // ---------------- ìƒí’ˆ ì²˜ë¦¬ ëª¨ë‹¬ ----------------
  $('#orderItems').on('click', '.process', function() {
    const i = orderItems[$(this).data('idx')];

    let originalHtml = `<h6>ì›ë˜ ìƒí’ˆ ì •ë³´</h6>
      <table class="table table-bordered mb-3">
        <tr><th>ìƒí’ˆëª…</th><td>${i.name}</td></tr>
        <tr><th>SKU</th><td>${i.sku}</td></tr>
        <tr><th>ìœ í†µê¸°í•œ</th><td>${i.MHD}</td></tr>
        <tr><th>ì£¼ë¬¸ìˆ˜ëŸ‰</th><td>${i.quantity}</td></tr>
        <tr><th>ìŠ¤ìº”ìˆ˜ëŸ‰</th><td>${i.scannedCount}</td></tr>
      </table>`;

    let tabsHtml = `
      <ul class="nav nav-tabs" id="processTab" role="tablist">
        <li class="nav-item">
          <a class="nav-link active" id="refund-tab" data-toggle="tab" href="#refund" role="tab">í™˜ë¶ˆ</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" id="replace-tab" data-toggle="tab" href="#replace" role="tab">ëŒ€ì²´</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" id="point-tab" data-toggle="tab" href="#point" role="tab">ì ë¦½</a>
        </li>
      </ul>
      <div class="tab-content mt-2">
        <div class="tab-pane fade show active" id="refund" role="tabpanel">
          <input class="form-control mb-1" placeholder="í™˜ë¶ˆ ìƒí’ˆëª…" id="refundName" value="${i.name}">
          <input class="form-control mb-1" placeholder="ìœ í†µê¸°í•œ" id="refundMHD" value="${i.MHD}">
          <input type="number" class="form-control mb-1" placeholder="í™˜ë¶ˆ ìˆ˜ëŸ‰" id="refundQty" min="1" max="${i.quantity}">
          <button class="btn btn-danger w-100 mb-2" id="refundBtn">í™˜ë¶ˆ ì™„ë£Œ</button>
        </div>
        <div class="tab-pane fade" id="replace" role="tabpanel">
          <input class="form-control mb-1" placeholder="ëŒ€ì²´ ìƒí’ˆëª…" id="replaceName">
          <input class="form-control mb-1" placeholder="ìœ í†µê¸°í•œ" id="replaceMHD">
          <input type="number" class="form-control mb-1" placeholder="ëŒ€ì²´ ìˆ˜ëŸ‰" id="replaceQty" min="1" max="${i.quantity}">
          <button class="btn btn-warning w-100 mb-2" id="replaceBtn">ëŒ€ì²´ ì™„ë£Œ</button>
        </div>
        <div class="tab-pane fade" id="point" role="tabpanel">
          <input type="number" class="form-control mb-1" placeholder="ì ë¦½ ìˆ˜ëŸ‰" id="pointQty" min="1">
          <button class="btn btn-info w-100 mb-2" id="pointBtn">ì ë¦½ ì™„ë£Œ</button>
        </div>
      </div>
    `;

    $('#processModalBody').html(originalHtml + tabsHtml);
    $('#processModal').modal('show');

    // ---------------- í™˜ë¶ˆ ----------------
    $('#refundBtn').off('click').on('click', function() {
      const qty = parseInt($('#refundQty').val());
      if(!qty || qty < 1) return alert('ìˆ˜ëŸ‰ ì…ë ¥ í•„ìš”');
      const entry = { type: 'í™˜ë¶ˆ', productName: $('#refundName').val(), MHD: $('#refundMHD').val(), quantity: qty };
      i.processHistory = i.processHistory || [];
      i.processHistory.push(entry);
      renderOrderItems();
    });

    // ---------------- ëŒ€ì²´ ----------------
    $('#replaceBtn').off('click').on('click', function() {
      const qty = parseInt($('#replaceQty').val());
      if(!qty || qty < 1) return alert('ìˆ˜ëŸ‰ ì…ë ¥ í•„ìš”');
      const entry = { type: 'ëŒ€ì²´', productName: $('#replaceName').val(), MHD: $('#replaceMHD').val(), quantity: qty };
      i.processHistory = i.processHistory || [];
      i.processHistory.push(entry);
      renderOrderItems();
    });

    // ---------------- ì ë¦½ ----------------
    $('#pointBtn').off('click').on('click', function() {
      const qty = parseInt($('#pointQty').val());
      if(!qty || qty < 1) return alert('ìˆ˜ëŸ‰ ì…ë ¥ í•„ìš”');
      const entry = { type: 'ì ë¦½', quantity: qty };
      i.processHistory = i.processHistory || [];
      i.processHistory.push(entry);
      renderOrderItems();
    });
  });

  // ---------------- ì§„í–‰ë¥  ----------------
  function updateProgressBar() {
    const total = orderItems.reduce((a, i) => a + i.quantity, 0);
    const done = orderItems.reduce((a, i) => a + i.scannedCount, 0);
    const progress = total ? Math.round((done / total) * 100) : 0;
    $('#progressBar').css('width', progress + '%').text(progress + '%');
  }

  function playSound(ok){ ok?soundSuccess.play():soundError.play(); }
  function speak(txt){ const u = new SpeechSynthesisUtterance(txt); u.lang='ko-KR'; tts.speak(u); }

});
</script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
</body>
</html>
